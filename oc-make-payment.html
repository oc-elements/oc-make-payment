<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../oc-core-utils/oc-core-utils.html">
<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../oc-form-container/oc-form-container.html">
<link rel="import" href="../oc-core-utils/oc-store.html">
<link rel="import" href="../oc-input-amount/oc-input-amount.html">
<link rel="import" href="../oc-paper-dialog/oc-paper-dialog.html">
<link rel="import" href="../../src/oc-button-styles.html">
<link rel="import" href="../oc-toast/oc-toast.html">


<dom-module id="oc-make-payment">

	<template>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<style include="shop-button oc-button-styles" is="custom-style">
			:host {
				display: block;
				background: #ffffff;
				color: #000;
			}

			.category-heading {
				border-top: 1px #cecece solid;
				border-bottom: 1px #cecece solid;
				background: #f8f8f8;
				color: #000;
			}

			h3 {
				font-size: 1.13em !important;
				margin: 10px 0 !important;
			}

			paper-dropdown-menu {
				width: 100%;
			}

			.method-icon {
				width: 16px;
				height: 16px;
				margin-right: 8px;
			}
		</style>
		<oc-toast id="toast"></oc-toast>
		<oc-accounts-api id="accountsApi"></oc-accounts-api>
		<oc-form-container header="Pay [[organisation.name]]">
			<template is="dom-if" if="[[error.isError]]">
				<div class="row">
					<div class="col-xs-12">
						<p class="error">
							<b>Payment Failed!</b> - [[error.message]]</p>
					</div>
				</div>
			</template>
			<div class="row">
				<div class="col-xs-12">
					<oc-input-amount id="inputAmount" amount="{{_amount}}" tabindex="1" autofocus>
					</oc-input-amount>

				</div>
			</div>
			<div class="row">
				<div class="col-xs-12">
					<paper-input id="beneficiaryRef" label="Reference" tabindex="2"></paper-input>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12">
					<paper-dropdown-menu label="From Account" horizontal-align="left" tabindex="3">
						<paper-listbox id="accountId" slot="dropdown-content" selected="{{_selectedAccountId}}" attr-for-selected="value">
							<template is="dom-repeat" items="[[_accountsList]]">
								<paper-item value="[[item.id]]">
									<iron-icon icon="[[_computeMethodIcon(item.methodKey)]]" class="method-icon"></iron-icon> [[_capatalize(item.name)]]</span>
								</paper-item>
							</template>
						</paper-listbox>
					</paper-dropdown-menu>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12">
					<paper-button id="submit" class="primary-button" on-click="_submit" disabled$="{{_loading}}" tabindex="4">Pay
					</paper-button>
				</div>
			</div>

			<oc-paper-dialog id="confirm" subject="Confirm Payment" body="
                             To: [[organisation.name]]
                             From: [[_fromSelectedMethod]]
                             Amount: [[formatMoneyAmount(_amount)]]" event-name="account-payment" primary-label="PAY" secondary-label="CANCEL">
			</oc-paper-dialog>
		</oc-form-container>
	</template>

	<script>
        /**
         * `oc-make-payment`
         * Flash payment element
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
		class OcMakePayment extends Ordercloud.Formatter(Ordercloud.ReduxMixin(Polymer.Element)) {
			static get is() {
				return 'oc-make-payment';
			}

			static get properties() {
				return {
					_userId: {
						type: Number,
						statePath: 'identity.user.id',

					},
					_organisationId: {
						type: Number,
						statePath: 'organisation.id',
					},
					_paymentData: {
						type: Object,
						value: {}
					},
					_amount: {
						type: Number,
					},
					_selectedAccountId: {
						type: Number
					},
					_fromSelectedMethod: {
						type: String
					},
					_toOrganisationId: {
						type: Number
					},
					organisation: Object,
					_accountsList: {
						type: Array,
						statePath: 'accounts.withdraw'
					},
					_default: {
						type: Number,
						statePath: 'accounts.default',
						observer: '_defaultAccount'
					},
					_loading: {
						type: Boolean,
						value: false,
						notify: true
					},
					_showPrefix: {
						type: Boolean,
						value: false,
						computed: '_computedShowPrefix(_paymentData.amount)'
					},//if the payment failed
					error: {
						type: Object,
						value: { "isError": false },
						notify: true
					},
					goBackUrl: {
						type: String,
						value: "/"
					}
				};
			}

			ready() {
				super.ready();
				this.addEventListener('account-payment', (e) => this._makePayment(e));
			}

			_computedShowPrefix(amount) {
				return !!amount;
			}

			_computedHasValue(amount) {
				return true;
			}

			//finds the shop to shop account and set as the default selected
			_defaultAccount(defaultAccount) {
				if (defaultAccount) {
					this._selectedAccountId = defaultAccount;
				}
			}

			_submit() {
				if (this._amount > 0) {
					//find the account name
					this._fromSelectedMethod = this._accountsList.filter(account => account.id === this._selectedAccountId).pop().name;
					this.$.confirm.open();
				}
				else {
					this.$.toast.failed("Payment value can't be 0");
				}
			}

			_makePayment() {
				if (!this.$.submit.disabled
					&& this._accountsList.length > 0
					&& this._selectedAccountId) {

					//disables the button
					this._loading = true;

					//build the data for the api call
					let data = {};
					data.fromAccountId = this._selectedAccountId;
					data.amount = this._amount;
					data.beneficiaryReference = this.$.beneficiaryRef.value;

					//passing the type along too know if should display otp page
					data.toOrganisationId = this.organisation.id;

					//passing the type along too know if should display otp page
					for (let i = 0; i < this._accountsList.length; i++) {
						if (this._accountsList[i].id === this._selectedAccountId)
							data.method = this._accountsList[i].method
					}

					// Clear fields after submit
					this._amount = 0;
					this.$.beneficiaryRef.value = "";

					this.dispatchEvent(new CustomEvent('pay-account', {
						bubbles: true,
						composed: true,
						detail: { paymentData: data }
					})
					);

					//disables the button
					this._loading = false;
				}
			}

			_computeMethodIcon(method) {
				switch (method) {
					case  'system':
						return 'custom:camel';
						break;
					case  'peach_registered_card':
						return 'icons:credit-card';
						break;
					case 'ivery':
						return 'dashboard:accounts-white';
						break;
					case  'flash_registered_msisdn':
						return 'cow:cow';
						break;
					case 'kazang_registered_account':
						return 'kazang:kazang';
					case  'bank_account':
						return 'icons:account-balance';
						break;
					case 'sfx':
						return 'sfx:sfx';
						break;
				}
			}

			//Capatalizes a string
			_capatalize(string) {
				return String(string).charAt(0).toUpperCase() + string.slice(1);
			}
		}

		window.customElements.define(OcMakePayment.is, OcMakePayment);
	</script>
</dom-module>
